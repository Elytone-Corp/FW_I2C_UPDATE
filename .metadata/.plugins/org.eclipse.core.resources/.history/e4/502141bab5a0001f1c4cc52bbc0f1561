

/*Script - flash_manager.c*/
// by:-  Ashutosh tiwari


#include "flash_manager.h"
#include "mxc_device.h"
#include "mxc_delay.h"
#include "flc.h"
#include <string.h>
#include <stdio.h>  // For error logging

#define MAX_RETRY_COUNT 3


#define PAGE_START_ADDR(addr)  ((addr) & ~(FLASH_PAGE_SIZE - 1))

// Error logging function
static void Flash_LogError(const char* message, int error_code) {
    printf("Flash Error: %s (Code: %d)\n", message, error_code);
}

// Initialize Flash Controller
void Flash_Init(void) {
    int ret = MXC_FLC_Init();
    if (ret != E_NO_ERROR) {
        Flash_LogError("Failed to initialize Flash Controller", ret);
        // Retry mechanism
        for (int attempt = 1; attempt <= MAX_RETRY_COUNT; attempt++) {
            ret = MXC_FLC_Init();
            if (ret == E_NO_ERROR) {
                printf("Flash Controller initialized on retry %d\n", attempt);
                return;
            }
            Flash_LogError("Retrying Flash Controller initialization", ret);
            MXC_Delay(MXC_DELAY_MSEC(50));  // Short delay between retries
        }
        // Critical failure if retries fail
        printf("Critical: Flash Controller initialization failed after %d attempts\n", MAX_RETRY_COUNT);
    }
}
